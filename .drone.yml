kind: pipeline
name: build base images

steps:
  - name: pull-binaries
    image: amidodevelopment/drone-runner-image:latest
    commands:
      - aws s3 sync s3://forgerock7-binaries . --no-progress

  - name: build-base-amster
    image: amidodevelopment/drone-runner-image:latest
    commands:
      - unzip -q Amster-7.0.*.zip -d amster
      - cd amster/samples/docker
      - ./setup.sh

  - name: build-empty-am
    image: amidodevelopment/drone-runner-image:latest
    commands:
      - unzip -q AM-7.0.*.zip -d am
      - cd am/openam/samples/docker
      - chmod u+x setup.sh
      - sed -i'.tmp' -e 's/[Oo]pen[Aa][Mm]/AM/g' setup.sh
      - sed -i'.tmp' -e 's/7.0.0/7.0.1/g' setup.sh
      - ./setup.sh
      - cd images/am-empty
      - chmod u+x docker-entrypoint.sh
      - chmod u+x scripts/*
      - sed -i'.tmp' -e 's/openam.war/AM.war/g' Dockerfile
      - cd ../am-base
      - chmod u+x docker-entrypoint.sh
      - chmod u+x scripts/*
      - sed -i'.tmp' -e 's/FROM amster/FROM '499815288658.dkr.ecr.eu-west-1.amazonaws.com'\\/id\\/amster/g' Dockerfile
      - sed -i'.tmp' -e 's/FROM am-empty/FROM '499815288658.dkr.ecr.eu-west-1.amazonaws.com'\\/id\\/am-base/g' Dockerfile

  - name: publish-am-empty
    image: plugins/ecr
    # environment:
    #   AWS_ACCESS_KEY_ID:
    #     from_secret: AWS_ACCESS_KEY_ID
    #   AWS_SECRET_ACCESS_KEY:
    #     from_secret: AWS_SECRET_ACCESS_KEY
    settings:
      repo: id/am-base
      registry: 714782054810.dkr.ecr.eu-west-2.amazonaws.com
      region: eu-west-1
      context: am/openam/samples/docker/images/am-empty
      dockerfile: am/openam/samples/docker/images/am-empty/Dockerfile
      force_tag: true
      tags:
        - "latest"
        - "${DRONE_COMMIT_SHA}"

  - name: build-base-ds
    image: openjdk:11
    commands:
      - mkdir ds
      - unzip -q ds.zip -d ds
      - cd ds/opendj
      - ./samples/docker/setup.sh

  - name: build-base-idm
    image: alpine:3.12.1
    commands:
      - mkdir idm
      - unzip -q idm.zip -d idm
      - cd idm/openidm

# steps:
#   - name: build-empty-am
#     image: amidodevelopment/drone-runner-image:latest
#     commands:
# - unzip -q AM-7.0.0.zip -d am
#       - unzip -q DS-7.0.0.zip -d ds
#       - unzip -q IG-7.0.0.zip -d ig
#       - unzip -q IDM-7.0.1.zip -d idm
# - cd amster/samples/docker
# - ./setup.sh
#       - docker build --tag amster:7.0 .
#       - cd /drone/src/am/openam/samples/docker
#       - chmod u+x setup.sh
#       - sed -i'.tmp' -e 's/[Oo]pen[Aa][Mm]/AM/g' setup.sh
#       - ./setup.sh
#       - cd images/am-empty
#       - chmod u+x docker-entrypoint.sh
#       - chmod u+x scripts/*
#       - sed -i'.tmp' -e 's/openam.war/AM.war/g' Dockerfile
#       - docker build --tag am-empty:7.0 .
#       - cd ../am-base
#       - chmod u+x docker-entrypoint.sh
#       - chmod u+x scripts/*
#       - docker build --build-arg docker_tag=7.0 --tag $ECR_REGISTRY/am-base:${DRONE_COMMIT_SHA:0:8} .
#       - docker tag amster:7.0 $ECR_REGISTRY/amster:${DRONE_COMMIT_SHA:0:8}
#       - cd /drone/src/ds/opendj
#       - ./samples/docker/setup.sh
#       - docker build --tag $ECR_REGISTRY/ds:${DRONE_COMMIT_SHA:0:8} .
#       - cd /drone/src/idm/openidm
#       - docker build . --file bin/Custom.Dockerfile --tag $ECR_REGISTRY/idm:${DRONE_COMMIT_SHA:0:8}
#       - cd /drone/src/ig/identity-gateway/docker
#       - docker build --tag $ECR_REGISTRY/ig:${DRONE_COMMIT_SHA:0:8} .

#   - name: publish
#     image: amidodevelopment/drone-runner-image:latest
#     environment:
#       AWS_ACCESS_KEY_ID:
#         from_secret: AWS_ACCESS_KEY_ID
#       AWS_SECRET_ACCESS_KEY:
#         from_secret: AWS_SECRET_ACCESS_KEY
#     volumes:
#       - name: dockersock
#         path: /var/run
#     commands:
#       - export ECR_REGISTRY=499815288658.dkr.ecr.eu-west-1.amazonaws.com
#       - aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin $ECR_REGISTRY
#       - docker push $ECR_REGISTRY/am-base:${DRONE_COMMIT_SHA:0:8}
#       - docker push $ECR_REGISTRY/amster:${DRONE_COMMIT_SHA:0:8}
#       - docker push $ECR_REGISTRY/ds:${DRONE_COMMIT_SHA:0:8}
#       - docker push $ECR_REGISTRY/idm:${DRONE_COMMIT_SHA:0:8}
#       - docker push $ECR_REGISTRY/ig:${DRONE_COMMIT_SHA:0:8}
#     when:
#       branch:
#         - master
#       event:
#         - push

# services:
#   - name: docker
#     image: docker:19.03.0-dind
#     privileged: true
#     volumes:
#       - name: dockersock
#         path: /var/run

# volumes:
#   - name: dockersock
#     temp: {}

image_pull_secrets:
  - dockerconfig
